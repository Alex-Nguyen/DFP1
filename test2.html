<!DOCTYPE html>
<html lang="en">
<head>
    <head>
        <meta charset="UTF-8">
        <title>Digital Forensics</title>
        <script src="https://d3js.org/d3.v4.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
        <script src="http://d3js.org/d3-selection-multi.v1.js"></script>
    </head>
</head>
<style>
    line { stroke: #999; stroke-opacity: .6;}
    .dllline{
        stroke: #999;
    }

    div.tooltip {
        position: absolute;
        text-align: center;
        width: 150px;
        height: 40px;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }

    div#treegraph {
        overflow: scroll;
        height: 600px;
        border: 1px;
        width:3000px;
        float: left;
    }

    svg {
        overflow: scroll;
    }

    .line {
        width: 0.5px;
    }
    text{color:black}

</style>
<body>
<fieldset>
    <legend>Data Overview - Number of API calls in each type</legend>
    <div id="stats"></div>
</fieldset>
<div id="divAnalysis">
    <button id="btnAnalysis">Analyze Process Create</button>
    <button id="btnLoadImage">Analyze Load Image</button>
</div>
<fieldset>
    <legend>
        Heat Map
    </legend>
    <div id="heatmap"></div>
</fieldset>

<script>
    var currentIndex = 0;//Keep track of current index;
    var rootObjects = {};
    var normalOSProcess=['CHXSmartScreen', 'MsMpEng',
        'TrustedInstaller','TiWorker','smartscreen',
        'lsass','csrss','PowerShellISE','vssvc','services'
        ,'OneDrive','wmiprvse','svchost','CHXSmartScreen',
        'SearchIndexer','SearchProtocolHost','SearchFilterHost',
        'LocationNotificationWindows','backgroundTaskHost','taskhostw','RuntimeBroker','sihost']
    var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);
    d3.xml('data/Logfile_Test2.XML', function (error, data) {
        if (error) throw error;
        data = [].map.call(data.querySelectorAll("event"), function (event) {
            return {
                Timestamp: event.querySelector("Time_of_Day").textContent,
                Second: (+event.querySelector("Time_of_Day").textContent.slice(5, 7)),
                Microsecond: (+event.querySelector("Time_of_Day").textContent.slice(8, 15)),
                PID: event.querySelector("PID").textContent,
                Process_Name: event.querySelector("Process_Name").textContent.replace(/[^a-zA-Z0-9]/g, '').slice(0,-3),
                Operation: event.querySelector("Operation").textContent,
                Path: event.querySelector("Path").textContent,
                Detail: event.querySelector("Detail").textContent,
                Step: 0
            };

        });
        var filterProcessCreate = [];

        for (var row = 1; row < data.length; row++) {
            var temp = ((data[row].Second * 10000000) + data[row].Microsecond) - ((data[row - 1].Second * 1000000) + data[row - 1].Microsecond)
            data[row].Step = (data[row - 1].Step + temp);

            var temp = data[row].Path.replace(/^.*[\\\/]/, ''), temp2 = temp.substr(temp.lastIndexOf('.') + 1);
            data[row].library ="";

            if (temp2.toLowerCase() == "dll") {
                data[row].library = temp;
            }

        }
        var data = data.filter(function (d) {
            // if((d.Process_Name !="SearchIndexer.exe")&&(d.Process_Name !="svchost.exe")&&(d.Process_Name !="SearchFilterHost.exe")&&(d.Process_Name !="SearchProtocolHost.exe")) return d;
            if (normalOSProcess.indexOf(d.Process_Name)==-1)
                return d;
        });
        // console.log(data)
        var group_by_library = d3.nest().key(function (d) {
            return d.library

        }).entries(data)

        group_by_library = group_by_library.filter(function (value) {
            if(value.key!=""&&value.key !="undefined"&&value.values.length > 20){
                return value;
            }
        })
        // console.log(group_by_library)

        
        var group_by_operation = d3.nest().key(function (d) {
            return d.Operation

        }).entries(data);
        console.log(group_by_operation)

        var maxcalls = d3.max(group_by_operation, function (d) {
            return d.values.length;
        });
        var mincalls = d3.min(group_by_operation, function (d) {
            return d.values.length;
        });
        var xScale = d3.scaleLinear()
            .domain([mincalls, maxcalls])
            .range([2, 500]);

        var group_by_pid = d3.nest().key(function (d) {
            return d.Process_Name

        }).entries(data);

        group_by_pid.forEach(function (d,i) {
            d.position = getPosition(d.key);
        })
        group_by_pid = group_by_pid.sort(function (a, b) {
            return a.position - b.position;
        })
        loadProcessByName();
        $('#btnAnalysis').on('click', function () {

            loadProcessByName();
        });

        function loadProcessByName() {
            d3.select('#heatmap').selectAll("*").remove();

            var margin_left = 100;
            var rect_height = 30, rect_margin_top = 10, group_rect_height = rect_height + rect_margin_top,
                rect_width = 0.8;
            var svgheight = group_by_pid.length * (group_rect_height);
            var max_step = d3.max(data, function (d) {
                return d.Step;
            });

            var StepScale = d3.scaleLinear()
                .domain([0, max_step])
                .range([0, 2300]);

            var svgpid = d3.select('#heatmap').append('svg').attr('width', 3000).attr('height', svgheight);
            svgpid.append("svg:defs").append("svg:marker")
                .attr("id", "arrow")
                .attr("refX", 0)
                .attr("refY", 4)
                .attr("markerWidth", 8)
                .attr("markerHeight", 8).attr('fill','rgb(37, 142, 215)')
                .attr("orient", 0).append('path').attr('d', 'M0,0 L0,8 L8,4 z');
            group_by_pid.forEach(function (row, index) {
                row.values.forEach(function (d, i) {

                    if (d.Operation == 'Process Create') {
                        var obj = d;
                        obj.currentStep = d.Step;
                        obj.currentLine = index;
                        obj.targetProcessName = d.Path.replace(/^.*[\\\/]/, '').slice(0,-4).replace(/[^a-zA-Z0-9]/g, '');
                        obj.childPID = d.Detail.slice(5, 9);
                        obj.targetLine = -1;
                        obj.tartgetX = -1;
                        filterProcessCreate.push(obj);
                    }
                    filterProcessCreate.forEach(function (target) {
                        if (d.PID == target.childPID && target.targetLine == -1 && target.tartgetX == -1) {
                            target.targetLine = index;
                            target.tartgetX = d.Step;
                        }
                    })
                })

                var group = svgpid.append('g').attr("transform", "translate(0," + index * group_rect_height + ")").attr('id',row.key).attr('index',index);
                group.append('text').text(row.key.slice(0,20)+'.exe')
                    .attr('x', ((StepScale(row.values[row.values.length - 1].Step)) * rect_width + margin_left) + 10).attr('y', 18).attr('font-weight', 'bold')
                    .attr('text-anchor', 'start');
                group.append('line').attr('stroke-dasharray', '2, 5').attr('stroke', 'black').attr('stroke-width', 0.1)
                    .attr('x1', (StepScale(row.values[0].Step) * rect_width + margin_left + 10)).attr('y1', rect_height / 2)
                    .attr('x2', (((StepScale(row.values[row.values.length - 1].Step)) * rect_width + margin_left) + 10)).attr('y2', rect_height / 2);
                var rectright = group.append('rect').attr('x',2400).attr('width', 40)
                    .attr('index',index)
                    .attr('height',rect_height).attr('id',row.key+'_right');
                rectright.attr('fill','rgb(204, 215, 255)');

                group.append('text').text(row.key.slice(0,20)+'.exe')
                    .attr('x', 2390).attr('y', 18).attr('font-weight', 'bold')
                    .attr('text-anchor', 'end');
                var rect = group.selectAll('rect').data(row.values).enter().append('rect')
                    .attr('x', function (d, i) {
                        return (StepScale(d.Step)) * rect_width + margin_left;
                    })
                    .attr('class', function (d, i) {
                        return d.Process_Name;
                    })
                    .attr('id', function (d) {
                        return d.Step;
                    })
                    .attr('width', rect_width)
                    .attr('height', rect_height)
                    .style('fill-opacity', 0.6)
                    .attr('fill', function (d) {
                        return colorPicker(d.Operation);
                    })
                    .on('mouseover', function (d) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html(d.Process_Name + "<br/>" + d.Timestamp + "<br/>" + d.Operation)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                    }).on("mouseout", function (d) {
                        div.transition()
                            .duration(500)
                            .style("opacity", 0)
                    })
            })
                        var pi = Math.PI;
            // console.log(filterProcessCreate)
            filterProcessCreate = filterProcessCreate.filter(function (d) {
                if(normalOSProcess.indexOf(d.targetProcessName)==-1)
                    return d;
            })

            filterProcessCreate.forEach(function (d) {
                if(d.targetLine==-1)
                    d.targetLine = getPosition(d.targetProcessName);
                svgpid.append('path')
                    .attr('d', d3.arc()
                        .innerRadius((d.targetLine - d.currentLine) * 40 / 2)
                        .outerRadius((d.targetLine - d.currentLine) * 40 / 2 + 1.5)
                        .startAngle(-pi) //converting from degs to radians
                        .endAngle(pi / 90))
                    .attr('fill', 'rgb(37, 142, 215)')
                    .attr('transform', function (value) {
                        var posX = (StepScale(d.currentStep)) * rect_width + margin_left - 1;
                       var posY = (d.targetLine + d.currentLine) * group_rect_height / 2 + rect_height / 2;

                        return 'translate(' + posX + ',' + posY + ')';
                    }).attr("marker-end", "url(#arrow)")
            })
            var dllGroup = svgpid.append('g').attr("transform", "translate(2800,0)");
            var number_of_dll = group_by_library.length;
            var padding =10;
            var dll_height = (svgheight - padding*(number_of_dll))/number_of_dll;


            var rectDLL = dllGroup.selectAll('rect').data(group_by_library).enter()
            rectDLL.append('rect').attr('x',0).attr('y',function (d,i) {
                return i*(dll_height+padding);
            }).attr('width',40).attr('height',dll_height).attr('fill','rgb(204, 215, 255)').attr('id',function (d) {
                return d.key.slice(0,-4);
            }).attr('index',function (d,i) {
                return i;
            })
            rectDLL.append('text').text(function (d) {
                return d.key +'('+ d.values.length+')';
            }).attr('x',70).attr('y',function (d,i) {
                return i*(dll_height+padding) + (dll_height+padding)/2;
            });

            var results = LoadDLLData();
            var temp_target = d3.nest().key(function (d) {
                return d.target;
            }).entries(results)
            var temp_source = d3.nest().key(function (d) {
                return d.source;
            }).entries(results)
            var colorLighter= d3.scaleLinear().domain([1,d3.max(temp_target, function (d) {
                return d.values.length;
            })])
                .range([d3.rgb(204, 215, 255), d3.rgb('rgb(31, 119, 180)')]);

            var colorSourceLighter = d3.scaleLinear().domain([1,d3.max(temp_source, function (d) {
                return d.values.length;
            })])
                .range([d3.rgb(204, 215, 255), d3.rgb('rgb(31, 119, 180)')]);
            temp_target.forEach(function (d) {
               d3.select('#'+d.key).attr('fill',colorLighter(d.values.length))
           })

            console.log(temp_source)
            temp_source.forEach(function (d) {
                d3.select('#'+d.key+'_right').attr('fill',colorSourceLighter(d.values.length))
            })
            var dllLines = svgpid.append('g');
            var ddlLineScale = d3.scaleLinear()
                .domain([d3.min(results,function (d) {
                    return d.value;
                }), d3.max(results,function (d) {
                    return d.value;
                })])
                .range([0.5, 3]);
            for(var i=0;i<results.length;i++){
                var indexSource = document.getElementById(results[i].source);
                var y1 =indexSource.getAttribute('index');
                var indexTarget = document.getElementById(results[i].target);
                var y2 =indexTarget.getAttribute('index');
                dllLines.append('line').attr('stroke-width',ddlLineScale(results[i].value)).attr('class','dllline')
                    .attr('x1',2440).attr('y1',y1*group_rect_height+rect_height/2)
                    .attr('x2',2800).attr('y2',y2*((dll_height+padding))+ (dll_height+padding)/2)
            }



        }

        function getPosition(process_name) {
            switch (process_name) {
                case "Explorer":
                    return 0;
                case "file4571518150a8181b403df4ae7ad54ce8b16ded0c":
                    return 1;
                case "WerFault":
                    return 2;
                case "njRAT":
                    return 3;
                case "fondue":
                    return 4;
                case "njq8":
                    return 5;
                case "FonDUE":
                    return 6;
                case "ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa":
                    return 7;
                case "attrib":
                    return 8;
                case "icacls":
                    return 9;
                case "taskdl":
                    return 10;
                case "WanaDecryptor":
                    return 11;
                case "cmd":
                    return 12;
                case "cscript":
                    return 13;
                case "vssadmin":
                    return 14;
                case "WMIC":
                    return 15;
                case "dwm":
                    return 16;
                case "wermgr":
                    return 17;
                case "consent":
                    return 18;
                case "AUDIODG":
                    return 19;
                case "DllHost":
                    return 20;
                case "taskhsvc":
                    return 21;
                case "conhost":
                    return 22;
                case "reg":
                    return 23;
                default:return 24;

            }
        }

        function loadHeatMap() {
            var call_per_lines = 10000;
            var MaxLength = d3.max(data, function (d) {
                return d.Step;
            });
            var window_size = 3000;
            var lines = Math.ceil(MaxLength / call_per_lines);
            var fullXScale = d3.scaleLinear()
                .domain([0, call_per_lines])
                .range([0, window_size]);
            var svgheatmap = d3.select("#heatmap").append('svg').attr("width", window_size + 100).attr("height", lines * 16);
            var barwidth = 1;
            for (var line = 0; line < lines; line++) {//Go for each lines
                //Run xposition from left to right
                var group = svgheatmap.append('g').attr("transform", "translate(0," + line * 16 + ")");
                var lineObj = [];
                for (var index = currentIndex; index < data.length; index++) {
                    if (data[index].Step < call_per_lines * (line + 1)) {
                        lineObj.push(data[index]);
                    }
                    else {
                        currentIndex = index;
                        break;
                    }
                }
                var rect = group.selectAll('rect').data(lineObj).enter().append('rect').attr("class", function (d) {
                    return d.Operation;
                }).attr("width", barwidth).attr('height', 15)
                    .attr('fill', function (d) {
                        return colorPicker(d.Operation);
                    })
                    .attr('x', function (d) {
                        return fullXScale(d.Step % call_per_lines);
                    })
                    .on('mouseover', function (d) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html(d.Process_Name + "<br/>" + d.PID + "<br/>")
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                    }).on("mouseout", function (d) {
                        div.transition()
                            .duration(500)
                            .style("opacity", 0)
                    })
            }
        }

        $('#btnLoadImage').on('click', function () {

            analyzeByLoadImage();
        });

        function analyzeByLoadImage() {
            console.log(group_by_operation)

        }

        createStats(group_by_operation);

        function createStats(stats_data) {
            stats_data.forEach(function (t) {
                var pname = getProcessName(t.key);
                if (!rootObjects.hasOwnProperty(pname)) {
                    var obj = new Object();
                    obj.pname = pname;
                    obj.operation = t.key;
                    obj.numcalls = t.values.length;
                    rootObjects[pname] = [];
                    rootObjects[pname].push(obj)
                } else {
                    var obj = new Object();
                    obj.pname = pname;
                    obj.operation = t.key;
                    obj.numcalls = t.values.length;
                    rootObjects[pname].push(obj)
                }
            });
            var datastats = [];
            for (var key in rootObjects) {
                rootObjects[key] = rootObjects[key].sort(function (a, b) {
                    return b.numcalls - a.numcalls;
                });
                datastats.push(rootObjects[key]);
            }
            loadStats(datastats);
        }

        function loadStats(datastats) {
            var svgStats = d3.select('#stats').append('svg').attr('width', 900).attr('height', 200);
            datastats.forEach(function (parent, index) {
                var group = svgStats.append('g').attr("transform", "translate(0," + index * 35 + ")");
                var xpos = 120;
                parent.forEach(function (t, i) {
                                        group.append('rect').attr('x', function (d) {
                        return xpos;
                    }).attr('width', function (d) {
                        return xScale(t.numcalls);
                    }).attr('height', 30)
                        .attr('fill', function (d) {
                            return colorPicker(t.operation);
                        }).on('mouseover', function (d) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html(t.operation + "<br/>" + t.numcalls + "<br/>" + "Click to see pattern")
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                    }).on("mouseout", function (d) {
                        div.transition()
                            .duration(500)
                            .style("opacity", 0);
                    }).on("click", function (d) {
                        var allrect = d3.select("#treegraph").selectAll('rect').style('opacity', 0);
                        d3.select("#treegraph").selectAll('rect.' + t.apicall).style('opacity', 1);
                    });
                    xpos += xScale(t.numcalls) + 2;
                })
                group.append('text').text(parent[0].pname + " (" + d3.sum(parent, function (d) {
                    return d.numcalls;
                }) + ")").attr('x', 0).attr('y', 18);
            })
        }

        function getProcessName(operation) {
            switch (operation) {
                case "Process Create":
                    return "Process";
                case "Load Image":
                    return "Process";
                case "CreateFile":
                    return "File";
                case "WriteFile":
                    return "File";
                case "SetRenameInformationFile":
                    return "File";
                case "RegCreateKey":
                    return "Registry";
                case "RegDeleteValue":
                    return "Registry";
                case "RegDeleteKey":
                    return "Registry";
                case "UDP Send":
                    return "Network";
                case "UDP Receive":
                    return "Network";
                case "TCP Receive":
                    return "Network";
                case "TCP Connect":
                    return "Network";
                case "TCP Send":
                    return "Network";

            }
        }

        function colorPicker(operation) {
            switch (operation) {
                case "Process Create":
                    return "rgb(37, 142, 215)";
                case "Load Image":
                    return "rgb(31, 119, 180)";
                case "CreateFile":
                    return "rgb(255, 152, 17)";
                case "WriteFile":
                    return "rgb(255, 127, 14)";
                case "SetRenameInformationFile":
                    return "rgb(255, 181, 20)";
                case "RegCreateKey":
                    return "rgb(44, 160, 44)";
                case "RegDeleteValue":
                    return "rgb(53, 191, 53)";
                case "RegDeleteKey":
                    return "rgb(63, 229, 63)";
                case "UDP Send":
                    return "rgb(214, 39, 40)";
                case "UDP Receive":
                    return "rgb(255, 47, 48)";
                case "TCP Receive":
                    return "rgb(255, 56, 57)";
                case "TCP Connect":
                    return "rgb(255, 80, 82)";
                case "TCP Send":
                    return "rgb(255, 67, 68)";
                default:
                    return "#000000";
            }
        }

        function LoadDLLData() {
            var nodedata =[];
            group_by_library.forEach(function (objList) {
                objList.values.forEach(function (d,i) {
                    var obj ={};
                    obj.source = d.Process_Name;
                    obj.target = objList.key.slice(0,-4);
                    obj.value = 1;
                    nodedata.push(obj);

                })

            })

            var result = Object.values(nodedata.reduce(function (r,e) {
                var key = e.source + '|' + e.target;
                if (!r[key]) r[key] = e;
                else {
                    r[key].value += e.value;
                }
                return r;
            },{}));

          return result;

        }
    })
</script>

</body>
</html>